# Operations Guide

This document provides operational guidance for deploying, configuring and
monitoring the Resync API application.  It consolidates information on
environment variables, startup/shutdown flow, deployment options and
health checks.

## Overview

The Resync API is a FastAPI application that integrates with Redis for
caching and rate limiting, Neo4j for knowledge graph persistence and
HTTPX for outbound requests.  Shared resources (Redis client, HTTP
client and Neo4j driver) are created during application startup and
cleanly closed on shutdown via the FastAPI lifespan context.

### Initialization flow

```text
+-------------------------------+
| FastAPI lifespan startup      |
|                               |
| 1. Validate environment vars  |
| 2. Create Redis client        |
| 3. Create HTTPX AsyncClient   |
| 4. Create Neo4j driver        |
| 5. Ensure Neo4j indexes       |
| 6. Yield control to server    |
+-------------------------------+
```

At shutdown the lifespan context closes the HTTPX client and Redis
client and logs any errors.

## Environment variables

The following variables influence runtime behaviour.  Defaults are shown
in parentheses.

| Variable                     | Purpose                                               |
|-----------------------------|-------------------------------------------------------|
| `REDIS_URL`                 | Redis connection URL (`redis://localhost:6379/0`)     |
| `REDIS_MAX_CONNECTIONS`     | Maximum Redis pool size (uses default if unset)       |
| `REDIS_CONNECT_TIMEOUT`     | Seconds to wait for Redis connection (5)              |
| `REDIS_SOCKET_TIMEOUT`      | Seconds before Redis read/write times out (3)         |
| `REDIS_HEALTH_CHECK_INTERVAL` | Interval for health checks on Redis connections (30) |
| `HTTP_MAX_CONNECTIONS`      | Max concurrent HTTP connections (uses default)        |
| `NEO4J_URI`                 | Neo4j URI (`neo4j://localhost:7687`)                  |
| `NEO4J_USER`                | Neo4j username (`neo4j`)                              |
| `NEO4J_PASSWORD`            | Neo4j password (empty)                                |
| `KG_BACKEND`                | Knowledge graph backend: `neo4j` or `stub` (`stub`)    |

When `KG_BACKEND=neo4j` and the driver cannot be initialised, the
application falls back to the in‑memory stub.  A warning is logged and
the environment summary is emitted at startup.

## Starting and stopping the application

For local development you can run the app using Uvicorn:

```bash
export RESYNC_ENV=development
uvicorn resync.fastapi_app.main:app --reload
```

In production the Docker image can be used.  The container runs
Gunicorn with Uvicorn workers by default.  Example:

```bash
docker build -t resync-api .
docker run -p 8000:8000 --env-file=.env resync-api
```

### Health check

The `/health` endpoint returns a simple 200 OK when the service is
healthy.  The Dockerfile includes a `HEALTHCHECK` instruction that
invokes this endpoint every 30 seconds.

### Metrics

Prometheus metrics are available at `/metrics`.  These include:

- `resync_rate_limit_hits_total` – number of requests rejected by the
  rate limiter.
- `resync_neo4j_query_latency_seconds` – histogram of Neo4j query
  durations.
- `resync_redis_connection_pool_active` – gauge of active Redis
  connections.
- `resync_httpx_active_connections` – gauge of active HTTP connections.
- Numerous other counters/gauges/histograms defined in the runtime
  metrics aggregator.

## Deployment notes

- Ensure Redis and Neo4j services are reachable from the container.
- Configure secrets (e.g. Neo4j password) via environment variables
  or a secrets manager.
- Mount or persist the `logs/` directory if you wish to retain
  structured logs generated by `config/structured_logging.py`.
- For Kubernetes deployments, map the readiness and liveness probes to
  `/health` and `/metrics` respectively.

## Commands summary

| Action             | Command                                                    |
|--------------------|------------------------------------------------------------|
| Run locally        | `uvicorn resync.fastapi_app.main:app --reload`             |
| Build Docker image | `docker build -t resync-api .`                             |
| Run container      | `docker run -p 8000:8000 --env-file=.env resync-api`       |
| Check health       | `curl -s http://localhost:8000/health`                    |
| View metrics       | `curl -s http://localhost:8000/metrics`                   |

## Additional resources

Refer to `CHANGELOG.md` for a detailed list of changes and
`docs/DEPLOYMENT_GUIDE.md` for advanced deployment scenarios.